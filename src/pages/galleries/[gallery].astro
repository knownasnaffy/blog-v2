---
import type { ImageMetadata } from "astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Datetime from "@/components/Datetime.astro";
import { SITE } from "@/config";

export async function getStaticPaths() {
  if (!SITE.showGalleries) return [];

  const galleries = await getCollection("galleries", ({ data }) => !data.draft);
  return galleries.map(gallery => ({
    params: {
      gallery: gallery.id
        .replace(/\/index\.(md|mdx)$/, "")
        .replace(/\.(md|mdx)$/, ""),
    },
    props: { entry: gallery },
  }));
}

const { entry } = Astro.props;
const { gallery: slug } = Astro.params;
const { title, description, pubDatetime, coverImage, tags } = entry.data;

// Load all images from the gallery at build-time with a static glob
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/data/galleries/**/*.{jpg,jpeg,png,webp,avif,gif,JPG,JPEG,PNG,WEBP}",
  { eager: true }
);

type GalleryImage = { src: ImageMetadata; alt: string; filename: string };

function filenameToAlt(filename: string): string {
  return (
    filename
      .replace(/\.[^.]+$/, "") // remove extension
      .replace(/^\d+[-_]?/, "") // remove leading number
      .replace(/[-_]/g, " ") // hyphens/underscores → spaces
      .replace(/\b\w/g, c => c.toUpperCase()) // capitalize
      .trim() || title
  );
}

const images: GalleryImage[] = Object.entries(allImages)
  .filter(
    ([path]) =>
      path.startsWith(`/src/data/galleries/${slug}/`) && !path.includes("index")
  )
  .sort(([a], [b]) => a.localeCompare(b))
  .map(([path, mod]) => {
    const filename = path.split("/").pop() ?? "";
    return { src: mod.default, alt: filenameToAlt(filename), filename };
  });

// If frontmatter has coverImage, include it at the beginning if not already in the list
const hasCoverInFolder = coverImage
  ? images.some(img => img.src.src === coverImage.src)
  : false;
---

<Layout title={`${title} | Galleries | ${SITE.title}`} description={description}>
  <Header />
  <Breadcrumb />
  <main id="main-content" class="app-layout pb-16">
    <!-- Gallery header -->
    <header class="gallery-detail-header">
      <div class="mb-1">
        <Datetime pubDatetime={pubDatetime} class="text-sm" />
      </div>
      <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">{title}</h1>
      {
        description && (
          <p class="mt-3 max-w-2xl text-foreground/70">{description}</p>
        )
      }
      {
        tags.length > 0 && (
          <div class="mt-3 flex flex-wrap gap-2">
            {tags.map(tag => (
              <span class="hero-badge">#{tag}</span>
            ))}
          </div>
        )
      }
      <p class="mt-4 text-sm text-foreground/50">
        {images.length}
        {images.length === 1 ? "imagen" : "imágenes"}
      </p>
    </header>

    <!-- Cubierta grande (si está definida en frontmatter y no está en la carpeta) -->
    {
      coverImage && !hasCoverInFolder && (
        <div class="mb-8 overflow-hidden rounded-2xl">
          <Image
            src={coverImage}
            alt={title}
            class="max-h-[60vh] w-full object-cover"
            loading="eager"
            widths={[800, 1200, 1600]}
            sizes="(max-width: 1200px) 100vw, 1200px"
          />
        </div>
      )
    }

    <!-- Grid de imágenes -->
    {
      images.length > 0 ? (
        <ul
          class="gallery-grid mt-6"
          id="gallery-grid"
          role="list"
          aria-label={`Imágenes de ${title}`}
        >
          {images.map((img, idx) => (
            <li>
              <button
                class="gallery-item group"
                data-index={idx}
                aria-label={`Ver imagen: ${img.alt}`}
                type="button"
              >
                <Image
                  src={img.src}
                  alt={img.alt}
                  class="gallery-img"
                  loading={idx < 6 ? "eager" : "lazy"}
                  widths={[400, 800]}
                  sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                />
                <div class="gallery-item-overlay">
                  <span class="gallery-item-alt">{img.alt}</span>
                </div>
              </button>
            </li>
          ))}
        </ul>
      ) : (
        <p class="mt-12 text-center text-foreground/50 italic">
          This gallery doesn't have images yet.
        </p>
      )
    }
  </main>
  <Footer />
</Layout>

<!-- Lightbox dialog -->
<dialog
  id="lightbox"
  class="lightbox"
  aria-label="Visor de imagen"
  aria-modal="true"
>
  <button
    class="lightbox-close"
    id="lightbox-close"
    aria-label="Cerrar"
    type="button"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
  <button
    class="lightbox-nav lightbox-prev"
    id="lightbox-prev"
    aria-label="Anterior"
    type="button"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <div class="lightbox-content">
    <img id="lightbox-img" src="" alt="" class="lightbox-image" />
    <p id="lightbox-caption" class="lightbox-caption"></p>
    <span id="lightbox-counter" class="lightbox-counter"></span>
  </div>
  <button
    class="lightbox-nav lightbox-next"
    id="lightbox-next"
    aria-label="Siguiente"
    type="button"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>
</dialog>

<script>
  // Construir array de imágenes desde el DOM
  function initGallery() {
    const grid = document.getElementById("gallery-grid");
    const lightbox = document.getElementById(
      "lightbox"
    ) as HTMLDialogElement | null;
    if (!grid || !lightbox) return;

    // A partir de aquí TypeScript no lleva el narrowing a closures; usamos la variable local
    const lb = lightbox;

    const items = Array.from(
      grid.querySelectorAll<HTMLButtonElement>(".gallery-item")
    );
    const lightboxImg = document.getElementById(
      "lightbox-img"
    ) as HTMLImageElement;
    const lightboxCaption = document.getElementById(
      "lightbox-caption"
    ) as HTMLElement;
    const lightboxCounter = document.getElementById(
      "lightbox-counter"
    ) as HTMLElement;
    const closeBtn = document.getElementById("lightbox-close");
    const prevBtn = document.getElementById("lightbox-prev");
    const nextBtn = document.getElementById("lightbox-next");

    let current = 0;

    function open(idx: number) {
      current = Math.max(0, Math.min(idx, items.length - 1));
      const btn = items[current];
      const img = btn.querySelector("img");
      if (!img) return;
      lightboxImg.src = img.src;
      lightboxImg.alt = img.alt;
      lightboxCaption.textContent = img.alt;
      lightboxCounter.textContent = `${current + 1} / ${items.length}`;
      lb.showModal();
      document.body.style.overflow = "hidden";
    }

    function close() {
      lb.close();
      document.body.style.overflow = "";
    }

    items.forEach((btn, idx) => {
      btn.addEventListener("click", () => open(idx));
    });

    closeBtn?.addEventListener("click", close);
    prevBtn?.addEventListener("click", () => open(current - 1));
    nextBtn?.addEventListener("click", () => open(current + 1));

    lightbox.addEventListener("click", e => {
      if (e.target === lb) close();
    });

    document.addEventListener("keydown", e => {
      if (!lb.open) return;
      if (e.key === "Escape") close();
      if (e.key === "ArrowLeft") open(current - 1);
      if (e.key === "ArrowRight") open(current + 1);
    });
  }

  // Inicializar en primera carga y en navegaciones SPA (View Transitions)
  initGallery();
  document.addEventListener("astro:after-swap", initGallery);
</script>

<style>
  /* ── Gallery detail header ── */
  .gallery-detail-header {
    padding-block: 2.5rem 2rem;
    border-bottom: 1px solid color-mix(in srgb, var(--border) 30%, transparent);
    margin-bottom: 2rem;
  }

  /* ── Image grid ── */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  @media (min-width: 640px) {
    .gallery-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
  }

  @media (min-width: 1024px) {
    .gallery-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .gallery-item {
    position: relative;
    display: block;
    width: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    border-radius: 0.75rem;
    cursor: zoom-in;
    background: color-mix(in srgb, var(--foreground) 5%, transparent);
    border: 1px solid color-mix(in srgb, var(--border) 25%, transparent);
    transition:
      border-color 0.2s,
      box-shadow 0.2s;
    padding: 0;
  }

  .gallery-item:hover {
    border-color: color-mix(in srgb, var(--accent) 40%, transparent);
    box-shadow: 0 4px 24px color-mix(in srgb, var(--accent) 12%, transparent);
  }

  .gallery-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
    display: block;
  }

  .gallery-item:hover .gallery-img {
    transform: scale(1.05);
  }

  .gallery-item-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    padding: 0.75rem;
    background: linear-gradient(
      to top,
      color-mix(in srgb, black 60%, transparent) 0%,
      transparent 60%
    );
    opacity: 0;
    transition: opacity 0.3s;
  }

  .gallery-item:hover .gallery-item-overlay,
  .gallery-item:focus-visible .gallery-item-overlay {
    opacity: 1;
  }

  .gallery-item-alt {
    font-size: 0.75rem;
    color: white;
    line-height: 1.3;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  /* ── Lightbox ── */
  .lightbox {
    position: fixed;
    inset: 0;
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    background: rgba(0, 0, 0, 0.92);
    border: none;
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    z-index: 100;
  }

  .lightbox::backdrop {
    background: transparent;
  }

  .lightbox:not([open]) {
    display: none;
  }

  .lightbox-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
    padding-block: 3.5rem;
    gap: 0.75rem;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: calc(100dvh - 10rem);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.5rem;
    box-shadow: 0 8px 48px rgba(0, 0, 0, 0.6);
  }

  .lightbox-caption {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
    text-align: center;
    max-width: 60ch;
    line-height: 1.5;
  }

  .lightbox-counter {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
  }

  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    z-index: 10;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox-nav {
    flex-shrink: 0;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition:
      background 0.2s,
      opacity 0.2s;
    margin-inline: 0.5rem;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  @media (max-width: 480px) {
    .lightbox-nav {
      position: absolute;
      bottom: 1rem;
      margin-inline: 0;
    }
    .lightbox-prev {
      left: 1rem;
    }
    .lightbox-next {
      right: 1rem;
    }
  }
</style>
