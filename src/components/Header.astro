---
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconArchive from "@/assets/icons/IconArchive.svg";
import IconGallery from "@/assets/icons/IconGallery.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import Logo from "@/assets/logo/devosfera.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<a
  id="skip-to-content"
  href="#main-content"
  class="absolute start-16 -top-full z-50 rounded-b-lg bg-accent px-4 py-2 font-medium text-background transition-all focus:top-0"
>
  Skip to content
</a>

<header id="main-header" class="sticky top-0 z-40 w-full transition-colors duration-300">
  <div class="app-layout">
    <div
      id="top-nav-wrap"
      class:list={[
        "py-3 sm:py-5",
        "relative w-full",
        "flex items-center justify-between",
        "transition-all duration-300",
      ]}
    >
      <!-- Logo -->
      <a
        href="/"
        class="group relative z-20 flex items-center gap-2 text-xl font-bold tracking-tight sm:text-2xl"
      >
        <!-- <span class="nav-logo-text">{SITE.title}</span> -->
        <Logo class="w-37.5 dark:invert" />
      </a>

      <!-- Nav area -->
      <nav id="nav-menu" class="flex items-center sm:gap-1">
        <!-- Mobile hamburger (animated lines) -->
        <button
          id="menu-btn"
          class="hamburger-btn sm:hidden"
          aria-label="Open Menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <div class="hamburger-box">
            <span class="hamburger-line hamburger-line--1"></span>
            <span class="hamburger-line hamburger-line--2"></span>
            <span class="hamburger-line hamburger-line--3"></span>
          </div>
        </button>

        <!-- Desktop links (always visible on sm+) -->
        <ul class="hidden sm:flex sm:flex-row sm:items-center sm:gap-1">
          <li>
            <a
              href="/posts"
              class:list={["nav-link", { "nav-active": isActive("/posts") }]}
              >Posts</a
            >
          </li>
          <li>
            <a
              href="/tags"
              class:list={["nav-link", { "nav-active": isActive("/tags") }]}
              >Tags</a
            >
          </li>
          <li>
            <a
              href="/about"
              class:list={["nav-link", { "nav-active": isActive("/about") }]}
              >About</a
            >
          </li>
          <li class="flex items-center">
            <a
              href="/search"
              class:list={["nav-link", { "nav-active": isActive("/search") }]}
              title="Ir a búsqueda">Search</a
            >
          </li>
          {
            SITE.showArchives && (
              <li>
                <LinkButton
                  href="/archives"
                  class:list={[
                    "nav-link",
                    { "nav-active": isActive("/archives") },
                  ]}
                  title="Archives"
                  aria-label="archives"
                >
                  <IconArchive class="hidden sm:inline-block" />
                  <span class="sm:sr-only">Archives</span>
                </LinkButton>
              </li>
            )
          }
          {
            SITE.showGalleries && (
              <li>
                <LinkButton
                  href="/galleries"
                  class:list={[
                    "nav-link",
                    { "nav-active": isActive("/galleries") },
                  ]}
                  title="Galerías"
                  aria-label="galleries"
                >
                  <IconGallery class="hidden sm:inline-block" />
                  <span class="sm:sr-only">Galerías</span>
                </LinkButton>
              </li>
            )
          }

          <!-- Separator -->
          <li class="flex items-center px-1" aria-hidden="true">
            <div class="h-4 w-px bg-border/30"></div>
          </li>

          <li class="flex items-center">
            <button
              data-search-trigger
              class="nav-search-btn"
              title="Buscar (⌘K)"
              aria-label="Abrir búsqueda"
              aria-keyshortcuts="Meta+K"
            >
              <IconSearch class="size-4.5" />
              <kbd class="nav-kbd">⌘K</kbd>
            </button>
          </li>
          {
            SITE.lightAndDarkMode && (
              <li class="flex items-center">
                <button
                  id="theme-btn"
                  class="nav-icon-btn relative"
                  title="Toggles light & dark"
                  aria-label="auto"
                  aria-live="polite"
                >
                  <IconMoon class="absolute top-1/2 left-1/2 -translate-1/2 scale-100 rotate-0 transition-all duration-300 dark:scale-0 dark:-rotate-90" />
                  <IconSunHigh class="absolute top-1/2 left-1/2 -translate-1/2 scale-0 rotate-90 transition-all duration-300 dark:scale-100 dark:rotate-0" />
                </button>
              </li>
            )
          }
        </ul>
      </nav>
    </div>
  </div>

  <!-- ===================== MOBILE DROPDOWN MENU (Floating Sheet) ===================== -->
  <div id="mobile-menu" class="mobile-menu sm:hidden" aria-hidden="true">
    <!-- Overlay/Backdrop -->
    <div class="mobile-menu-backdrop"></div>
    
    <!-- Floating Glass Panel -->
    <div class="app-layout">
      <div class="mobile-menu-panel relative mt-2 w-full mx-auto rounded-2xl border border-white/10 dark:border-white/5 overflow-hidden shadow-2xl">
        <div class="mobile-menu-inner">
          <nav class="mobile-nav-links">
            <a
              href="/posts"
              class:list={["mobile-nav-link", { active: isActive("/posts") }]}
              style="--i:0"
            >
              <span class="mobile-nav-indicator"></span>
              <span>Posts</span>
            </a>
            <a
              href="/tags"
              class:list={["mobile-nav-link", { active: isActive("/tags") }]}
              style="--i:1"
            >
              <span class="mobile-nav-indicator"></span>
              <span>Tags</span>
            </a>
            <a
              href="/about"
              class:list={["mobile-nav-link", { active: isActive("/about") }]}
              style="--i:2"
            >
              <span class="mobile-nav-indicator"></span>
              <span>About</span>
            </a>
            {
              SITE.showArchives && (
                <a
                  href="/archives"
                  class:list={[
                    "mobile-nav-link",
                    { active: isActive("/archives") },
                  ]}
                  style="--i:3"
                >
                  <span class="mobile-nav-indicator" />
                  <span>Archives</span>
                </a>
              )
            }
            {
              SITE.showGalleries && (
                <a
                  href="/galleries"
                  class:list={[
                    "mobile-nav-link",
                    { active: isActive("/galleries") },
                  ]}
                  style="--i:4"
                >
                  <span class="mobile-nav-indicator" />
                  <span>Galerías</span>
                </a>
              )
            }
          </nav>

          <!-- Divider -->
          <div class="mobile-menu-divider"></div>

          <!-- Bottom action row -->
          <div class="mobile-menu-actions">
            <button
              data-search-trigger
              class="mobile-action-btn flex-1 justify-center"
              title="Buscar (⌘K)"
              aria-label="Abrir búsqueda"
            >
              <IconSearch class="size-4" />
              <span>Search</span>
            </button>
            {
              SITE.lightAndDarkMode && (
                <button
                  id="theme-btn-mobile"
                  class="mobile-action-btn flex-1 justify-center"
                  title="Cambiar tema"
                  aria-label="auto"
                  aria-live="polite"
                >
                  <IconMoon class="block size-4 dark:hidden" />
                  <IconSunHigh class="hidden size-4 dark:block" />
                  <span class="block dark:hidden">Dark mode</span>
                  <span class="hidden dark:block">Light mode</span>
                </button>
              )
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom border with gradient -->
  <div
    id="header-border"
    class="header-border-line opacity-0 transition-opacity duration-300 h-px w-full bg-linear-to-r from-transparent via-border/40 to-transparent"
  >
  </div>
</header>

<style>
  /* ─── Header Glass & Scroll Physics ─── */
  #main-header {
    background: transparent;
  }
  
  :global(.header-scrolled) {
    background: color-mix(in srgb, var(--background) 80%, transparent) !important;
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
  }

  .nav-logo-text {
    background: linear-gradient(
      135deg,
      var(--foreground) 0%,
      var(--foreground) 60%,
      var(--accent) 100%
    );
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* ─── Logo SVG hover effects ─── */
  :global(.logo-text-left),
  :global(.logo-text-right) {
    transition:
      transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
      filter 0.4s ease;
  }
  :global(.logo-sphere) {
    transition:
      transform 0.3s ease,
      filter 0.3s ease;
    transform-origin: 342px 130px;
  }

  .group:hover :global(.logo-text-left) {
    transform: translateX(-5px);
    filter: drop-shadow(0 0 3px rgba(56, 66, 77, 0.2));
  }
  .group:hover :global(.logo-text-right) {
    transform: translateX(5px);
    filter: drop-shadow(0 0 3px rgba(56, 66, 77, 0.2));
  }
  .group:hover :global(.logo-sphere) {
    filter: drop-shadow(0 0 8px rgba(167, 90, 90, 0.5));
    animation: sphere-wiggle 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  }

  @keyframes sphere-wiggle {
    0% {
      transform: rotate(0deg) scale(1);
    }
    20% {
      transform: rotate(-8deg) scale(1.1);
    }
    40% {
      transform: rotate(5deg) scale(1.15);
    }
    60% {
      transform: rotate(-3deg) scale(1.12);
    }
    80% {
      transform: rotate(1deg) scale(1.08);
    }
    100% {
      transform: rotate(0deg) scale(1.06);
    }
  }

  /* ─── Desktop nav links ─── */
  .nav-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .nav-link:focus-visible, .nav-icon-btn:focus-visible, .nav-search-btn:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 50%, transparent);
  }

  .nav-link:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .nav-active {
    color: var(--accent);
    /* Clean active state for desktop */
    background: transparent;
  }

  /* Glowing dot for active state (macOS Dock style) */
  .nav-active::after {
    content: "";
    position: absolute;
    bottom: -0.1rem;
    left: 50%;
    transform: translateX(-50%);
    width: 0.35rem;
    height: 0.35rem;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px color-mix(in srgb, var(--accent) 80%, transparent);
  }

  .nav-icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    color: var(--foreground);
  }

  .nav-icon-btn:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  /* ─── Desktop Search Button with ⌘K ─── */
  .nav-search-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.5rem 0.3rem 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--muted-foreground);
    border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
    border-radius: 0.5rem;
    background: color-mix(in srgb, var(--muted) 40%, transparent);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-search-btn:hover {
    color: var(--accent);
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .nav-kbd {
    display: inline-flex;
    align-items: center;
    font-family: inherit;
    font-size: 0.6875rem;
    font-weight: 600;
    line-height: 1;
    padding: 0.15rem 0.35rem;
    border-radius: 0.25rem;
    border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
    border-bottom-width: 2px;
    background: color-mix(in srgb, var(--background) 90%, transparent);
    color: var(--muted-foreground);
    box-shadow: inset 0 -1px 0 rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }

  .nav-search-btn:hover .nav-kbd {
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    color: var(--accent);
  }

  /* ─── Animated Hamburger Button ─── */
  .hamburger-btn {
    position: relative;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.625rem;
    border: 1px solid transparent;
    background: transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  @media (min-width: 640px) {
    .hamburger-btn {
      display: none;
    }
  }

  .hamburger-btn:hover,
  .hamburger-btn[aria-expanded="true"] {
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    border-color: color-mix(in srgb, var(--accent) 15%, transparent);
  }

  .hamburger-box {
    position: relative;
    width: 18px;
    height: 14px;
  }

  .hamburger-line {
    position: absolute;
    left: 0;
    display: block;
    width: 100%;
    height: 2px;
    border-radius: 2px;
    background: var(--foreground);
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hamburger-line--1 {
    top: 0;
  }
  .hamburger-line--2 {
    top: 6px;
  }
  .hamburger-line--3 {
    top: 12px;
    width: 60%;
  }

  /* Open state: morph to X */
  .hamburger-btn[aria-expanded="true"] .hamburger-line {
    background: var(--accent);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--1 {
    top: 6px;
    transform: rotate(45deg);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--2 {
    opacity: 0;
    transform: scaleX(0);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--3 {
    top: 6px;
    width: 100%;
    transform: rotate(-45deg);
  }

  /* ─── Mobile Menu Floating Sheet ─── */
  .mobile-menu {
    position: absolute; /* float over content */
    top: 100%;
    left: 0;
    width: 100%;
    z-index: 30;
    pointer-events: none; /* Let clicks pass through when closed */
  }

  .mobile-menu.is-open {
    pointer-events: auto;
  }

  .mobile-menu-backdrop {
    position: fixed;
    inset: 0;
    z-index: -1;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    transition: all 0.4s ease;
    opacity: 0;
    pointer-events: none;
  }

  .mobile-menu.is-open .mobile-menu-backdrop {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 1;
    pointer-events: auto; /* Catch clicks outside */
  }

  .mobile-menu-panel {
    background: color-mix(in srgb, var(--background) 80%, transparent);
    backdrop-filter: blur(24px) saturate(200%);
    -webkit-backdrop-filter: blur(24px) saturate(200%);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
    /* Animation state */
    opacity: 0;
    transform: translateY(-8px) scale(0.98);
    transform-origin: top center;
    transition: all 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
    visibility: hidden;
  }

  .mobile-menu.is-open .mobile-menu-panel {
    opacity: 1;
    transform: translateY(0) scale(1);
    visibility: visible;
  }

  /* ─── Mobile Menu Inner ─── */
  .mobile-menu-inner {
    position: relative;
    padding: 1rem;
  }

  /* ─── Mobile Nav Links ─── */
  .mobile-nav-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mobile-nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 1.05rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.75rem;
    transition: all 0.1s ease-out; /* Snappier hover */
    /* Stagger entrance */
    opacity: 0;
    transform: translateY(8px);
  }

  .mobile-menu.is-open .mobile-nav-link {
    /* For the entrance animation, override the transition to use the entrance speed */
    transition: all 0.25s ease;
    opacity: 1;
    transform: translateY(0);
    transition-delay: calc(0.08s * var(--i, 0) + 0.12s);
  }

  .mobile-nav-link:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .mobile-nav-link.active {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
  }

  .mobile-nav-indicator {
    display: block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--foreground) 20%, transparent);
    transition: all 0.1s ease-out; /* Snappier indicator */
    flex-shrink: 0;
  }

  .mobile-nav-link.active .mobile-nav-indicator {
    background: var(--accent);
    box-shadow: 0 0 8px color-mix(in srgb, var(--accent) 50%, transparent);
  }

  .mobile-nav-link:hover .mobile-nav-indicator {
    background: var(--accent);
  }

  /* ─── Menu Divider ─── */
  .mobile-menu-divider {
    margin: 0.75rem 0.5rem;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      color-mix(in srgb, var(--border) 40%, transparent),
      transparent
    );
  }

  /* ─── Mobile Action Buttons ─── */
  .mobile-menu-actions {
    display: flex;
    gap: 0.5rem;
    /* Stagger delay (after nav links) */
    opacity: 0;
    transform: translateY(6px);
    transition: all 0.3s ease;
  }

  .mobile-menu.is-open .mobile-menu-actions {
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.35s;
  }

  .mobile-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.625rem;
    border: 1px solid color-mix(in srgb, var(--border) 20%, transparent);
    background: color-mix(in srgb, var(--background) 50%, transparent);
    backdrop-filter: blur(8px);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .mobile-action-btn:hover {
    color: var(--accent);
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }
</style>

<script>
  let headerCleanup: AbortController | null = null;
  let scrollCleanup: AbortController | null = null;

  function setupScrollPhysics() {
    if (scrollCleanup) scrollCleanup.abort();
    scrollCleanup = new AbortController();
    const { signal } = scrollCleanup;

    const header = document.getElementById("main-header");
    const navWrap = document.getElementById("top-nav-wrap");
    const borderLine = document.getElementById("header-border");

    if (!header || !navWrap || !borderLine) return;

    const handleScroll = () => {
      if (window.scrollY > 15) {
        header.classList.add("header-scrolled");
        navWrap.classList.remove("sm:py-5");
        navWrap.classList.add("sm:py-3");
        borderLine.classList.remove("opacity-0");
        borderLine.classList.add("opacity-100");
      } else {
        header.classList.remove("header-scrolled");
        navWrap.classList.add("sm:py-5");
        navWrap.classList.remove("sm:py-3");
        borderLine.classList.add("opacity-0");
        borderLine.classList.remove("opacity-100");
      }
    };

    window.addEventListener("scroll", handleScroll, { passive: true, signal });
    handleScroll(); // Init instantly
  }

  function setupMobileNav() {
    // Cleanup previous listeners
    if (headerCleanup) headerCleanup.abort();
    headerCleanup = new AbortController();
    const { signal } = headerCleanup;

    const menuBtn = document.querySelector("#menu-btn");
    const mobileMenu = document.querySelector("#mobile-menu");
    const backdrop = document.querySelector(".mobile-menu-backdrop");

    if (!menuBtn || !mobileMenu) return;
    
    const closeMenu = () => {
      menuBtn.setAttribute("aria-expanded", "false");
      menuBtn.setAttribute("aria-label", "Open Menu");
      mobileMenu.classList.remove("is-open");
      mobileMenu.setAttribute("aria-hidden", "true");
    };

    menuBtn.addEventListener(
      "click",
      () => {
        const isOpen = menuBtn.getAttribute("aria-expanded") === "true";

        if (isOpen) {
          closeMenu();
        } else {
          menuBtn.setAttribute("aria-expanded", "true");
          menuBtn.setAttribute("aria-label", "Close Menu");
          mobileMenu.classList.add("is-open");
          mobileMenu.setAttribute("aria-hidden", "false");
        }
      },
      { signal }
    );
    
    // Close when clicking the backdrop
    if (backdrop) {
      backdrop.addEventListener("click", closeMenu, { signal });
    }

    // Close mobile menu on link click
    mobileMenu.querySelectorAll("a").forEach(link => {
      link.addEventListener("click", closeMenu, { signal });
    });
  }

  // Initial load
  setupScrollPhysics();
  setupMobileNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", () => {
    setupScrollPhysics();
    setupMobileNav();
  });
</script>
